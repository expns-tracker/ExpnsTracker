<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Home</title>
    <style>
        @media only screen and (max-width: 600px) {
            .stat-card-title {
                font-size: 1.1rem !important;
            }
            .stat-card-value {
                font-size: 1.4rem !important;
            }
            .card.horizontal {
                display: block !important;
            }
            .card.horizontal .card-image {
                max-width: 100% !important;
                width: 100% !important;
                height: 60px !important;
            }
            .card.horizontal .card-stacked {
                width: 100% !important;
            }
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="container" style="margin-top: 30px;">

        <div class="row center-align" th:if="${currentUser != null}">
            <div class="col s12">
                <h4 class="hide-on-small-only">Welcome back, <span th:text="${currentUser.firstName}">User</span>!</h4>
                <h5 class="hide-on-med-and-up">Hi, <span th:text="${currentUser.firstName}">User</span>!</h5>

                <p class="flow-text grey-text text-darken-1" style="font-size: 1.1rem;">Manage your expenses securely.</p>

                <div style="margin-top: 20px;">
                    <a th:href="@{/tink/connect}" class="btn waves-effect waves-light blue darken-1" style="width: 100%; max-width: 200px; margin-bottom: 10px;">
                        <i class="material-icons left">link</i>Connect Bank
                    </a>

                    <a th:if="${currentUser.syncStatus != 'RUNNING'}"
                       th:href="@{/tink/load-transactions}"
                       class="btn waves-effect waves-light green darken-1" style="width: 100%; max-width: 200px; margin-bottom: 10px;">
                        <i class="material-icons left">sync</i>Sync Now
                    </a>

                    <button th:if="${currentUser.syncStatus == 'RUNNING'}" class="btn disabled" style="width: 100%; max-width: 200px; margin-bottom: 10px;">
                        <i class="material-icons left">hourglass_empty</i>Syncing...
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="row" style="margin-top: 30px;" th:if="${currentUser != null}">

            <!-- 1. Current Balance -->
            <div class="col s12">
                <div class="card horizontal hoverable blue lighten-5 z-depth-1">
                    <div class="card-image blue lighten-1 center-align valign-wrapper">
                        <i class="material-icons white-text large" style="width: 100%;">account_balance</i>
                    </div>
                    <div class="card-stacked">
                        <div class="card-content" style="padding: 20px;">
                            <span class="card-title blue-text text-darken-2 stat-card-title">Current Balance</span>
                            <!-- Calculation: Income - Expenses -->
                            <h4 class="stat-card-value" style="margin-top: 10px;" th:text="${#numbers.formatCurrency(currentUser.balance ?: 0)}">€0.00</h4>
                            <p class="grey-text">Net Flow</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Total Income -->
            <div class="col s12 m6">
                <div class="card horizontal hoverable green lighten-5 z-depth-1">
                    <div class="card-image green lighten-1 center-align valign-wrapper">
                        <i class="material-icons white-text medium" style="width: 100%;">trending_up</i>
                    </div>
                    <div class="card-stacked">
                        <div class="card-content" style="padding: 15px;">
                            <span class="card-title green-text text-darken-2 stat-card-title">Income</span>

                            <h5 class="stat-card-value" th:text="${#numbers.formatCurrency(currentUser.currentMonthIncome ?: 0)}">€0.00</h5>
                            <p class="grey-text">Current Month</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col s12 m6">
                <div class="card horizontal hoverable red lighten-5 z-depth-1">
                    <div class="card-image red lighten-1 center-align valign-wrapper">
                        <i class="material-icons white-text medium" style="width: 100%;">trending_down</i>
                    </div>
                    <div class="card-stacked">
                        <div class="card-content" style="padding: 15px;">
                            <span class="card-title red-text text-darken-2 stat-card-title">Expenses</span>
                            <h5 class="stat-card-value" th:text="${#numbers.formatCurrency(currentUser.currentMonthExpenses ?: 0)}">€0.00</h5>
                            <p class="grey-text">Current Month</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Table -->
        <div class="row" th:if="${currentUser != null}">
            <div class="col s12">
                <div class="card z-depth-1">
                    <div class="card-content">
                        <span class="card-title">Recent Activity</span>
                        <div class="table-responsive">
                            <table class="highlight responsive-table">
                                <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="tx : ${recentTransactions}">
                                    <td th:text="${#dates.format(tx.date.toDate(), 'dd MMM')}">01 Dec</td>
                                    <td th:text="${tx.description}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Coffee</td>
                                    <td><span class="new badge blue" data-badge-caption="" th:text="${tx.categoryName}">Food</span></td>
                                    <td th:text="${#numbers.formatCurrency(tx.amount)}"
                                        th:class="${tx.amount < 0} ? 'red-text' : 'green-text'">-€5.00</td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(recentTransactions)}">
                                    <td colspan="4" class="center-align grey-text">No recent transactions found.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-action right-align">
                            <a href="/transactions" class="blue-text">View All</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

</body>
</html>